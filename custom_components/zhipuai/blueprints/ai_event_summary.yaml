blueprint:
  name: AIäº‹ä»¶æ‘˜è¦ (æ™ºè°±AIè§†è§‰åˆ†æ Plus)
  author: knoop7
  description: >
    åŸºäºæ™ºè°±AIçš„æ‘„åƒå¤´äº‹ä»¶åˆ†æï¼Œå¯ä»¥æ™ºèƒ½åˆ†ææ‘„åƒå¤´ç”»é¢å¹¶ç”Ÿæˆäº‹ä»¶æ‘˜è¦ã€‚
    å‘æ‚¨çš„æ‰‹æœºå‘é€å¸¦é¢„è§ˆçš„é€šçŸ¥ï¼Œå½“AIåˆ†æå®Œæˆåä¼šåŠ¨æ€æ›´æ–°ã€‚

    åŠŸèƒ½ç‰¹ç‚¹ï¼š
    1. æ”¯æŒå¤šä¸ªæ‘„åƒå¤´å’Œä¼ æ„Ÿå™¨çš„é…å¯¹
    2. å®æ—¶åˆ†æï¼šä¼ æ„Ÿå™¨è§¦å‘æ—¶ç«‹å³å¼€å§‹åˆ†æ
    3. åŒé‡é€šçŸ¥ï¼šå…ˆå‘é€è§¦å‘æé†’ï¼Œåˆ†æå®Œæˆåæ›´æ–°ç»“æœ
    4. æ™ºèƒ½åˆ†æï¼šä½¿ç”¨æ™ºè°±AIçš„è§†è§‰æ¨¡å‹åˆ†æç”»é¢å†…å®¹
    5. ç¾è§‚é€šçŸ¥ï¼šåŒ…å«å®æ—¶é¢„è§ˆå’Œåˆ†æç»“æœ
    6. é‡è¦æ€§è¿‡æ»¤ï¼šå¯é€‰æ‹©åªå…³æ³¨é‡è¦äº‹ä»¶
    7. å†å²è®°å½•ï¼šå¯é€‰æ‹©ä¿å­˜äº‹ä»¶è®°å½•

    ä½¿ç”¨è¯´æ˜ï¼š
    1. é€‰æ‹©è¦ç›‘æ§çš„æ‘„åƒå¤´
    2. é€‰æ‹©å¯¹åº”çš„è§¦å‘ä¼ æ„Ÿå™¨ï¼ˆæŒ‰é¡ºåºåŒ¹é…ï¼‰
    3. é€‰æ‹©æ¥æ”¶é€šçŸ¥çš„è®¾å¤‡
    4. è‡ªå®šä¹‰åˆ†æè¦æ±‚ï¼ˆå¯é€‰ï¼‰
    5. é€‰æ‹©åˆé€‚çš„AIæ¨¡å‹
    6. é…ç½®å…¶ä»–é€‰é¡¹ï¼ˆé‡è¦æ€§è¿‡æ»¤ã€å†å²è®°å½•ç­‰ï¼‰

    æ³¨æ„äº‹é¡¹ï¼š
    1. ä¼ æ„Ÿå™¨å’Œæ‘„åƒå¤´éœ€è¦ä¸€ä¸€å¯¹åº”
    2. ç¡®ä¿è®¾å¤‡æ”¯æŒé€šçŸ¥åŠŸèƒ½
    3. å»ºè®®ä½¿ç”¨ç§»åŠ¨ä¼ æ„Ÿå™¨æˆ–é—¨çª—ä¼ æ„Ÿå™¨è§¦å‘
  domain: automation
  source_url: https://raw.githubusercontent.com/knoop7/zhipuai/refs/heads/v2025.01.09-dev/custom_components/zhipuai/blueprints/ai_event_summary.yaml
  input:
    important:
      name: é‡è¦æ€§è¿‡æ»¤
      description: >
        ä½¿ç”¨AIå°†äº‹ä»¶åˆ†ç±»ä¸º"å…³é”®"ã€"æ™®é€š"å’Œ"ä½é‡è¦æ€§"ã€‚
        ä»…å½“äº‹ä»¶è¢«åˆ†ç±»ä¸ºè‡³å°‘"æ™®é€š"æ—¶æ‰å‘é€é€šçŸ¥ã€‚
        å¯¹äºå…³é”®äº‹ä»¶ï¼Œå³ä½¿åœ¨"å‹¿æ‰°æ¨¡å¼"ä¸‹ä¹Ÿä¼šå‘é€é€šçŸ¥ã€‚
        è¯·è°¨æ…ä½¿ç”¨ï¼šAIå¯èƒ½ä¼šåˆ¤æ–­é”™è¯¯ã€‚
      default: false
      selector:
        boolean:
    remember:
      name: è®°å½•å†å²
      description: ä¿å­˜äº‹ä»¶è®°å½•ï¼Œæ–¹ä¾¿æ‚¨ä¹‹åæŸ¥çœ‹å’Œå›é¡¾ã€‚å¦‚æœå¼€å¯äº†æ™ºèƒ½è¿‡æ»¤ï¼Œåªè®°å½•é‡è¦å’Œæ™®é€šäº‹ä»¶ã€‚
      default: false
      selector:
        boolean:
    camera_entities:
      name: æ‘„åƒå¤´å®ä½“
      description: >
        é€‰æ‹©è¦ç›‘æ§çš„æ‘„åƒå¤´ã€‚
        æ³¨æ„ï¼šæ‘„åƒå¤´çš„é¡ºåºè¦ä¸ä¸‹é¢çš„ä¼ æ„Ÿå™¨é¡ºåºå¯¹åº”ã€‚
      selector:
        entity:
          multiple: true
          filter:
            domain: camera
    motion_sensors:
      name: è§¦å‘ä¼ æ„Ÿå™¨
      description: >
        é€‰æ‹©è§¦å‘åˆ†æçš„ä¼ æ„Ÿå™¨ã€‚
        å¯ä»¥æ˜¯ç§»åŠ¨ä¼ æ„Ÿå™¨ã€é—¨çª—ä¼ æ„Ÿå™¨ç­‰ä»»ä½•äºŒå…ƒä¼ æ„Ÿå™¨ã€‚
        æ³¨æ„ï¼šä¼ æ„Ÿå™¨çš„é¡ºåºè¦ä¸ä¸Šé¢çš„æ‘„åƒå¤´é¡ºåºå¯¹åº”ã€‚
      selector:
        entity:
          multiple: true
          filter:
            domain: binary_sensor
    notify_device:
      name: é€šçŸ¥è®¾å¤‡
      description: >
        é€‰æ‹©æ¥æ”¶é€šçŸ¥çš„è®¾å¤‡ã€‚
        å¿…é¡»æ˜¯å·²ç»å®‰è£…äº†Home Assistantåº”ç”¨çš„ç§»åŠ¨è®¾å¤‡ã€‚
        æ”¯æŒé€‰æ‹©å¤šä¸ªè®¾å¤‡åŒæ—¶æ¥æ”¶é€šçŸ¥ã€‚
      selector:
        device:
          multiple: true
          filter:
            integration: mobile_app
    preview_mode:
      name: é¢„è§ˆæ¨¡å¼
      description: >
        é€‰æ‹©å®æ—¶é¢„è§ˆæˆ–äº‹ä»¶å¿«ç…§ï¼š
        - å®æ—¶é¢„è§ˆï¼šæ˜¾ç¤ºæ‘„åƒå¤´å½“å‰ç”»é¢
        - å¿«ç…§ï¼šä¿å­˜å¹¶æ˜¾ç¤ºè§¦å‘æ—¶çš„ç”»é¢
      default: 'å®æ—¶é¢„è§ˆ'
      selector:
        select:
          options:
            - 'å®æ—¶é¢„è§ˆ'
            - 'å¿«ç…§'
    tap_navigate:
      name: ç‚¹å‡»å¯¼èˆª
      description: >
        ç‚¹å‡»é€šçŸ¥æ—¶å¯¼èˆªåˆ°çš„è·¯å¾„ï¼ˆä¾‹å¦‚ï¼š/lovelace/camerasï¼‰ã€‚
        ç•™ç©ºåˆ™æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆã€‚
      default: "/lovelace/cameras"
      selector:
        text:
          multiline: false
    message:
      name: åˆ†æè¦æ±‚
      description: >
        å‘Šè¯‰AIè¦å…³æ³¨ç”»é¢ä¸­çš„å“ªäº›å†…å®¹ã€‚
        å¯ä»¥åŒ…å«å¤šä¸ªå…³æ³¨ç‚¹ï¼Œå»ºè®®ä½¿ç”¨åˆ†ç‚¹åˆ—ä¸¾çš„æ–¹å¼è¯´æ˜ã€‚
        ä¾‹å¦‚å…³æ³¨äººç‰©ã€è¡Œä¸ºã€ç©¿ç€ã€å¯ç–‘è¡Œä¸ºç­‰ã€‚
      default: "è¯·åˆ†æç”»é¢ä¸­å‘ç”Ÿäº†ä»€ä¹ˆï¼Œé‡ç‚¹å…³æ³¨ï¼š
        1. æ˜¯å¦æœ‰äºº
        2. åœ¨åšä»€ä¹ˆåŠ¨ä½œ
        3. ç©¿ç€ç‰¹å¾
        4. æ˜¯å¦æœ‰å¯ç–‘è¡Œä¸º
        5. æ˜¯å¦å­˜åœ¨å®‰å…¨éšæ‚£"
      selector:
        text:
          multiline: true
    model:
      name: AIæ¨¡å‹
      description: >
        é€‰æ‹©ç”¨äºåˆ†æçš„æ™ºè°±AIæ¨¡å‹ï¼š
        - glm-4v-flashï¼šå¿«é€Ÿåˆ†æï¼Œé€‚åˆç®€å•åœºæ™¯
        - glm-4v-plusï¼šè¯¦ç»†åˆ†æï¼Œé€‚åˆå¤æ‚åœºæ™¯
      default: "glm-4v-flash"
      selector:
        select:
          options:
            - "glm-4v-flash"
            - "glm-4v-plus"
    cooldown:
      name: å†·å´æ—¶é—´
      description: >
        ä¸¤æ¬¡åˆ†æä¹‹é—´çš„æœ€å°é—´éš”æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰ã€‚
        é˜²æ­¢é¢‘ç¹è§¦å‘å¯¼è‡´åˆ†ææ¬¡æ•°è¿‡å¤šã€‚
        å»ºè®®æ ¹æ®åœºæ™¯è®¾ç½®åˆé€‚çš„é—´éš”ã€‚
      default: 1
      selector:
        number:
          min: 0
          max: 60
          unit_of_measurement: åˆ†é’Ÿ

variables:
  notify_devices: !input notify_device
  device_name_map: >
    {% set ns = namespace(device_names=[]) %}
    {% for device_id in notify_devices %}
      {% set device_name = device_attr(device_id, "name")|lower|replace(" ", "_") %}
      {% set ns.device_names = ns.device_names + [device_name] %}
    {% endfor %}
    {{ ns.device_names }}
  camera_entity: >
    {% if trigger.entity_id in motion_sensors %}
      {% set index = motion_sensors.index(trigger.entity_id) %}
      {{ camera_entities[index] if index < camera_entities|length else camera_entities[0] }}
    {% endif %}
  camera_name: >
    {{ camera_entity.replace("camera.", "").replace("_", " ")|title }}
  sensor_name: >
    {{ trigger.entity_id.replace("binary_sensor.", "").replace("_", " ")|title }}
  image: >
    {% if preview_mode == 'å®æ—¶é¢„è§ˆ' %}
      {{ '/api/camera_proxy/' + camera_entity }}
    {% else %}
      {% set camera = camera_entity|default('') %}
      {% if camera %}
        /local/zhipuai/{{camera.replace("camera.", "")}}_0.jpg
      {% else %}
        ''
      {% endif %}
    {% endif %}
  notification_id: >
    {{ camera_entity + "_" + now().strftime("%Y%m%d_%H%M%S") }}
  importance_prompt: >
    æ‚¨çš„ä»»åŠ¡æ˜¯æ ¹æ®ç›‘æ§ç”»é¢å¯¹å®‰é˜²äº‹ä»¶è¿›è¡Œåˆ†ç±»ã€‚é€‰é¡¹ï¼š"passive"è¡¨ç¤ºäº‹ä»¶ä¸é‡è¦ï¼Œ"time-sensitive"è¡¨ç¤ºé‡è¦ï¼Œ"critical"è¡¨ç¤ºå¯ç–‘äº‹ä»¶ã€‚
    ä»…åœ¨å¯èƒ½å‘ç”Ÿå…¥å®¤ç›—çªƒç­‰ç±»ä¼¼äº‹ä»¶æ—¶ä½¿ç”¨"critical"ã€‚"time-sensitive"å¯èƒ½æ˜¯å¿«é€’å‘˜åœ¨é—¨å£æˆ–ç±»ä¼¼é‡è¦æ€§çš„äº‹ä»¶ã€‚
    è¯·ä¸¥æ ¼ä½¿ç”¨è¿™äº›å›å¤ã€‚

mode: single
max_exceeded: silent

trigger:
  - platform: state
    entity_id: !input motion_sensors
    to: "on"
    for: 
      seconds: 1

condition:
  - condition: template
    value_template: >
      {{ trigger.entity_id in motion_sensors }}
  - condition: template
    value_template: >
      {{ camera_entity is defined and camera_entity != '' }}
  - condition: state
    entity_id: "{{ camera_entity }}"
    state: "on"

action:
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ important }}"
        sequence:
          - action: zhipuai.image_analyzer
            data:
              model: !input model
              message: "{{importance_prompt}}"
              image_entity: "{{camera_entity}}"
            response_variable: importance

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ importance is defined and importance.response_text|lower == 'passive' }}"
        sequence:
          - stop: "äº‹ä»¶ä¸é‡è¦"

  - alias: "å‘é€åˆå§‹é€šçŸ¥"
    repeat:
      for_each: "{{device_name_map}}"
      sequence:
        - service: notify.{{ repeat.item }}
          data:
            title: "âš¡ {{ sensor_name }} è§¦å‘"
            message: |
              ğŸ“¸ æ­£åœ¨åˆ†æ {{ camera_name }} çš„ç”»é¢...
              â³ è¯·ç¨å€™ï¼ŒAIæ­£åœ¨å¤„ç†ä¸­...
            data:
              image: "{{image}}"
              entity_id: "{{camera_entity}}"
              tag: "motion_{{notification_id}}"
              importance: high
              channel: motion
              alert_once: true
              url: !input tap_navigate
              clickAction: !input tap_navigate

  - alias: "åˆ†æäº‹ä»¶"
    action: zhipuai.image_analyzer
    data:
      model: !input model
      message: !input message
      image_entity: "{{camera_entity}}"
    response_variable: response

  - alias: "å‘é€åˆ†æç»“æœ"
    repeat:
      for_each: "{{device_name_map}}"
      sequence:
        - service: notify.{{ repeat.item }}
          data:
            title: "ğŸ¤– æ™ºè°±AIåˆ†æç»“æœ"
            message: |
              ğŸ“ ä½ç½®ï¼š{{ camera_name }}
              ğŸ•’ æ—¶é—´ï¼š{{ now().strftime("%H:%M:%S") }}
              
              åˆ†æç»“æœï¼š
              {{ response.response_text }}
              
              ğŸ’¡ è§¦å‘æºï¼š{{ sensor_name }}
              {% if importance is defined %}
              âš ï¸ é‡è¦æ€§ï¼š{{ importance.response_text }}
              {% endif %}
            data:
              image: "{{image}}"
              entity_id: "{{camera_entity}}"
              tag: "motion_{{notification_id}}"
              importance: "{{ 'critical' if importance is defined and importance.response_text == 'critical' else 'high' }}"
              channel: motion
              sticky: true
              persistent: true
              url: !input tap_navigate
              clickAction: !input tap_navigate

  - delay:
      minutes: !input cooldown
